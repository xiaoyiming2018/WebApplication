@{
    @model Model.Order;
    @using Model;
    @using BLL;
}

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="~/assets/css/sweetalert.css">
    <script type="text/javascript" src="~/assets/js/sweetalert-dev.js"></script>
    <script type="text/javascript" src="~/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="~/Scripts/jquery-1.10.2.min.js"></script>

    <script type="text/javascript">
        $(function () {
            $(".sidebar ul li:nth-of-type(4)").addClass("active open")
            $(".sidebar ul li:nth-of-type(4) ul li:nth-of-type(1)").addClass("active")
            $('#submit').click(function () {

                var order_index = $('#order_index').val();
                var company_order_index = $('#company_order_index').val();
                var customer_id = $('#customer_id').val();

                var seq_id = $('#seq_id').val();
                var order_id = $('#order_id').val();
                var order_name = $('#order_name').val();
                var order_time = $('#order_time').val();
                var deliver_time = $('#deliver_time').val();
                var unit = $('#unit').val();
                var order_num = $('#order_num').val();
                var order_price = $('#order_price').val();
                var order_all_price = $('#order_all_price').val();
                var order_picture = $('#order_picture').val();
                var purchase_person = $('#purchase_person').val();
                if (order_name == "" || order_time == "" || order_num == "" || order_price == "" || order_all_price == "" || deliver_time == "" || unit == "" || purchase_person == "") {

                    swal("信息不能为空！", "请将信息补充完整！", "error");
                }
                else {
                    $.ajax({
                        type: "POST",
                        url: "/OrderSeq/EditHandle",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("XSRF-TOKEN",
                                $('input:hidden[name="__RequestVerificationToken"]').val());
                        },
                        data: {
                            order_index: order_index, company_order_index: company_order_index, customer_id:customer_id,seq_id: seq_id,order_name: order_name, order_time: order_time,
                            order_num: order_num, order_price: order_price, order_all_price: order_all_price,
                            deliver_time: deliver_time, unit: unit, order_id: order_id, order_picture: order_picture, purchase_person: purchase_person
                        },
                        success: function (msg) {
                            if (msg == "Success") {
                                swal({ title: "执行成功!", text: "", type: "success" },
                                    function () { window.location.href = '/Order/Index'; });
                                
                            }                     
                            else {
                                swal("执行失败！", "", "error");
                            }
                        },
                        error: function (msg) {
                            swal("数据获取失败！", "", "error");
                        }
                    });
                }

            });

            $("#btn_fileUpload").click(function () {
                var fileUpload = $("#files").get(0);
                var files = fileUpload.files;
                var data = new FormData();
                for (var i = 0; i < files.length; i++) {
                    data.append(files[i].name, files[i]);
                }
                if (files.length <= 0) {
                    swal("请先上传再提交！", "", "error");
                }
                else
                {
                    $.ajax({
                        type: "POST",
                        url: "/api/File",
                        contentType: false,
                        processData: false,
                        data: data,
                        success: function (data) {
                            if (data == "Fail") {
                                swal("上传文件有误！", "仅支持pdf文档！", "error");
                            }
                            else {
                                var filecode = document.getElementById("order_picture");
                                filecode.value = data;
                                swal("上传成功！", "", "success");
                            }

                        },
                        error: function (data) {
                            swal("上传失败！", "" + data + "", "error");

                        }
                    });
                }
                
            });
        })

        function getProductPrice() {
            var order_num = $('#order_num').val()
            var order_price = $('#order_price').val()
            if (order_num >= 0 && order_price>=0) {
                $.ajax({
                    type: "POST",
                    url: "/OrderSeq/GetProductPrice",
                    data: { order_num: order_num, order_price: order_price},
                    success: function (msg) {
                        $('#price_div').html(msg);
                    },
                    error: function (msg) {
                        swal("获取价格失败！", "", "error");
                    }
                });
            }
        }
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="page-header">
                    <div class="page-title">
                        <ol class="breadcrumb text-left">
                            <li><a href="/Supplier/Index">主页</a></li>
                            <li><a href="/Order/Index">订单管理</a></li>
                            <li><a href="/Order/Index">订单列表</a></li>
                            <li class="active">
                                @{ if (Model == null)
                                    { <text>新增订单</text>}
                                else
                                { <text>编辑订单</text>}}
                            </li>
                        </ol>
                    </div>
                </div>
            </div><!-- /# column -->
        </div><!-- /# row -->
        <div class="main-content">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card alert">
                        <div class="card-header">
                            <h4>订单详情</h4>
                        </div>
                    <br />
                        <div class="card-body">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-1 control-label">订单号：</label>
                                    <div class="col-sm-2">
                                        <input type="text" class="form-control" id="order_index" name="order_index" value="@ViewBag.order_index" disabled="disabled" />
                                    </div>
                                    <label class="col-sm-2 control-label">客户订单号：</label>
                                    <div class="col-sm-2">
                                        <input type="text" class="form-control" id="company_order_index" name="company_order_index" value="@ViewBag.company_order_index" @if (Model == null) { <text> readonly</text>} />
                                    </div>
                                    <label class="col-sm-2 control-label">公司名称：</label>
                                    <div class="col-sm-2">
                                        <select class="form-control" id="customer_id" name="customer_id">
                                            <option value=""></option>
                                            @{
                                                CompanyManager CM = new CompanyManager();
                                                List<Company> objList = CM.SelectAll(type: 0);
                                                if (objList.Count > 0)
                                                {
                                                    for (int i = 0; i < objList.Count; i++)
                                                    {
                                                        <!option value="@objList[i].id" @if (objList[i].company_name == ViewBag.company_name) { <text> selected</text>} @if (Model == null) { <text> disabled</text>}>@objList[i].company_name</!option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- /# card -->
                </div><!-- /# column -->
                <div class="col-lg-12">
                    <div class="card alert">
                        <div class="card-header">
                            <h4>
                                @{ if (Model == null)
                                    { <text>新增订单</text>}
                                else
                                { <text>编辑订单</text>}}
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="basic-form">
                                <div class="form-horizontal">
                                    <input type="hidden" value="@if (Model != null) {@Model.seq_id} else { <text>0</text>} " id="seq_id" name="seq_id" />
                                    <input type="hidden" value="@ViewBag.order_id" id="order_id" name="order_id" />

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">名称规格</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="order_name" name="order_name" value="@if (Model != null) { @Model.order_name; } " @if (Model != null) { <text> readonly</text>} />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">下单时间</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="order_time" name="order_time" onclick="WdatePicker({ skin: 'whyGreen',dateFmt:'yyyy-MM-dd' })" value="@if (Model != null) {@Model.deliver_time.ToString("yyyy-MM-dd")} else { @ViewBag.order_time}" readonly/>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">交货日期</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="deliver_time" name="deliver_time" onclick="WdatePicker({ skin: 'whyGreen',dateFmt:'yyyy-MM-dd' })" value="@if (Model != null) {@Model.deliver_time.ToString("yyyy-MM-dd")} else { @ViewBag.order_time}" />
                                        </div>
                                    </div>


                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">单位</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="unit" name="unit" value="@if (Model != null) {@Model.unit}" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">数量</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="order_num" name="order_num" placeholder="0" value="@if (Model != null) {@Model.order_num}" @if (Model != null) { <text> readonly</text>} onchange="getProductPrice()" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">单价</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="order_price" name="order_price" placeholder="0" value="@if (Model != null) {@Model.order_price}" onchange="getProductPrice()" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">总价</label>
                                        <div class="col-sm-4" id="price_div">
                                            <input type="text" class="form-control" id="order_all_price" name="order_all_price" placeholder="0" value="@if (Model != null) {@Model.order_all_price}" readonly />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">图纸上传</label>
                                        <div class="col-sm-4">
                                            <input type="file" id="files" name="files" placeholder="file" class="form-control" style="border:none;outline:none" />
                                            <input type="hidden" id="order_picture" name="order_picture" value="@if (Model != null) {@Model.order_picture}" />
                                        </div>
                                        <div class="col-sm-4">
                                            <input type="button" id="btn_fileUpload" name="btn_fileUpload" class="btn btn-primary" value="上传" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">采购员</label>
                                        <div class="col-sm-4" id="price_div">
                                            <input type="text" class="form-control" id="purchase_person" name="purchase_person" value="@if (Model != null) {@Model.purchase_person}" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="col-sm-6 control-label" id="prompt" style="color:red"></div>
                                    </div>
                                    <div class="form-group" style="display:block">
                                        <div class="col-sm-offset-5">
                                            <input type="button" id="submit" name="submit" class="btn btn-primary" style=" width:12%" value="提交" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- /# card -->
                </div><!-- /# column -->
            </div><!-- /# row -->
        </div>
    </div><!-- /# container-fluid -->
</body>
</html>


