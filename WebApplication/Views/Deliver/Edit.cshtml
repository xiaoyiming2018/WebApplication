@{
    @model Model.Purchase;
    @using Model;
    @using BLL;
}

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="~/assets/css/sweetalert.css">
    <script type="text/javascript" src="~/assets/js/sweetalert-dev.js"></script>
    <script type="text/javascript" src="~/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="~/Scripts/jquery-1.10.2.min.js"></script>

    <script type="text/javascript">
        var TempArr = [];//存储option
        $(function () {
            $(".sidebar ul li:nth-of-type(2)").addClass("active open")
            $(".sidebar ul li:nth-of-type(2) ul li:nth-of-type(1)").addClass("active")
            $(".sidebar ul li:nth-of-type(2) ul li:nth-of-type(2)").removeClass("active open")


            $('#submit').click(function () {
                var id = $('#id').val();
                var purchase_index = $('#purchase_index').val();
                var supplier_id = $('#supplier_id').val();
                var category = $('#category').val();
                var material_name = $('#material_name').val();
                var material_spec = $('#material_spec').val();
                var material_num = $('#material_num').val();
                var material_unit = $('#material_unit').val();
                var material_price = $('#material_price').val();
                var material_all_price = $('#material_all_price').val();
                
                var deliver_index = $('#deliver_index').val();
                var deliver_time = $('#deliver_time').val();
                var money_onoff = $('#money_onoff').val();
                var money_way = $('#money_way').val();
                
                if (deliver_index == "" || deliver_time == "" || purchase_index == "" || category == "" || material_name == "" || material_num <= 0 ||
                    material_spec == "" || material_unit == "" || material_price == "" || material_all_price == "") {
                    swal("输入信息有误！","请重新填写内容","error");
                }
                else if (supplier_id<= 0)
                {
                    swal("供应商不存在！", "请从下拉框中选择相应的供应商！", "error");
                }
                else if (money_way < 1)
                {
                     swal("请选择结账方式！", "", "error");
                }
                else {
                    $.ajax({
                        type: "POST",
                        url: "/Deliver/EditHandle",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("XSRF-TOKEN",
                                $('input:hidden[name="__RequestVerificationToken"]').val());
                        },
                        data: {
                            id: id, purchase_index: purchase_index, supplier_id: supplier_id, category: category, material_name: material_name,
                            material_num: material_num, material_spec: material_spec, material_unit: material_unit, material_price: material_price,
                            material_all_price: material_all_price, deliver_index: deliver_index, deliver_time: deliver_time, money_onoff: money_onoff, money_way: money_way},
                        success: function (msg) {
                            if (msg == "Success") {
                                swal({ title: "执行成功!", text: "", type: "success" },
                                    function () { window.location.href = '/Deliver/Index';});                  
                            }
                            else {
                                swal("执行失败！", "", "error");
                            }
                        },
                        error: function (msg) {
                            swal("数据获取失败！", "请重新提交内容！", "error");
                        }
                    });
                }

            });
        });

        function getProductPrice() {
            var material_num = $('#material_num').val()
            var material_price = $('#material_price').val()
            if (material_num >= 0 && material_price >= 0) {
                $.ajax({
                    type: "POST",
                    url: "/Deliver/GetProductPrice",
                    data: { material_num: material_num, material_price: material_price },
                    success: function (msg) {
                        $('#price_div').html(msg);
                    },
                    error: function (msg) {
                        swal("获取规格失败！", "", "error");
                    }
                });
            }
        }

        function SelectTip(flag) {
            var TxtObj = document.getElementById("txtPlace");
            var SelectObj = document.getElementById("supplier_id")
            var Arr = []
            with (SelectObj) {
                var SelectHTML = innerHTML.match(/<[^>]*>/)[0]
                for (i = 0; i < TempArr.length; i++)
                    if (TempArr[i][0].indexOf(TxtObj.value, 0) >= 0 || flag )//若找到以txt的内容开头的，添加option。若flag为true，对下拉框初始化
                        Arr[Arr.length] = "<option value='" + TempArr[i][1] + "'>" + TempArr[i][0] + "</option>"
                innerHTML = SelectHTML + Arr.join() + "</SELECT>"
            }
        }

        function Init() {
            var SelectObj = document.getElementById("supplier_id");
            /*先将数据存入数组*/
            with (SelectObj)
            for (i = 0; i < length; i++)
                TempArr[i] = [options[i].text, options[i].value]
        }
    </script>
</head>
<body onload="Init()">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="page-header">
                    <div class="page-title">
                        <ol class="breadcrumb text-left">
                            <li><a href="/Supplier/Index">主页</a></li>
                            <li><a href="/Deliver/Index">物料购入流水账</a></li>
                            <li class="active">
                                @{ if (Model == null)
                                    { <text>新增</text>}
                                else
                                { <text>编辑</text>}}
                            </li>
                        </ol>
                    </div>
                </div>
            </div><!-- /# column -->
        </div><!-- /# row -->
        <div class="main-content">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card alert">
                        <div class="card-header">
                            <h4>
                                @{ if (Model == null)
                                    { <text>新增</text>}
                                else
                                { <text>编辑</text>}}
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="basic-form" name=newform>
                                <div class="form-horizontal">
                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">购入单号</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="purchase_index" name="purchase_index" value="@if (Model != null) {@Model.purchase_index } else { @ViewBag.purchase_index} " @if (Model != null) { <text> readonly</text>} />
                                            <input type="hidden" class="form-control" id="id" name="id" value="@if (Model!=null) {@Model.id } " readonly />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">供应商</label>
                                        <div class="col-sm-4">
                                            <input id="txtPlace" name="txtPlace" class="form-control" onkeyup="SelectTip(0)">
                                            <select class="form-control" id="supplier_id" name="supplier_id" onchange="txtPlace.value=options[selectedIndex].text;" size=5>
                                                <option value=""></option>
                                                @{
                                                    CompanyManager CM = new CompanyManager();
                                                    List<Company> objList = CM.SelectAll(type: 1);
                                                    if (objList.Count > 0)
                                                    {
                                                        for (int i = 0; i < objList.Count; i++)
                                                        {
                                                            <!option value="@objList[i].id" @if (Model != null) { if (objList[i].id == Model.supplier_id) { <text> selected</text> } }>@objList[i].company_name</!option>
                                                        }
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">分类</label>
                                        <div class="col-sm-4">
                                            <select class="form-control" id="category" name="category">
                                                <option value=""></option>
                                                @{
                                                    SettingManager SM = new SettingManager();
                                                    List<Setting> sList = SM.SelectConfigList(2);
                                                    if (sList.Count > 0)
                                                    {
                                                        for (int i = 0; i < sList.Count; i++)
                                                        {
                                                            <!option value="@sList[i].config_list" @if (Model != null) { if (sList[i].config_list == Model.category) { <text> selected</text> } }>@sList[i].config_list</!option>
                                                        }
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">物料名称</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="material_name" name="material_name" value="@if (Model!=null) {@Model.material_name }" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">物料规格</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="material_spec" name="material_spec" value="@if (Model!=null) {@Model.material_spec }" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">购入数量</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="material_num" name="material_num" placeholder="0" value="@if (Model!=null) {@Model.material_num }" onchange="getProductPrice()" @if (Model!=null) {<text>readonly</text> } />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">物料单位</label>
                                        <div class="col-sm-4">
                                            <select class="form-control" id="material_unit" name="material_unit">
                                                <option value=""></option>
                                                @{
                                                    SettingManager UM = new SettingManager();
                                                    List<Setting> uList = UM.SelectConfigList(1);
                                                    if (uList.Count > 0)
                                                    {
                                                        for (int i = 0; i < uList.Count; i++)
                                                        {
                                                            <!option value="@uList[i].config_list" @if (Model != null) { if (uList[i].config_list == Model.material_unit) { <text> selected</text> } }>@uList[i].config_list</!option>
                                                        }
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">单价</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="material_price" name="material_price" value="@if (Model!=null) {@Model.material_price }" onchange="getProductPrice()" />
                                        </div>
                                    </div>

                                    <div class="form-horizontal" id="price_div">
                                        <div class="form-group">
                                            <label for="example-input-normal" class="col-sm-4 control-label">总价</label>
                                            <div class="col-sm-4">
                                                <input type="text" class="form-control" id="material_all_price" name="material_all_price" placeholder="0" value="@if (Model !=null) { @Model.material_all_price}" readonly />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">送货单号</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="deliver_index" name="deliver_index" value="@if (Model !=null) { @Model.deliver_index} " />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">送货时间</label>
                                        <div class="col-sm-4">
                                            <input type="text" class="form-control" id="deliver_time" name="deliver_time" onclick="WdatePicker({ skin: 'whyGreen',dateFmt:'yyyy-MM-dd' })" value="@if (Model !=null) { @Model.deliver_time.ToString("yyyy-MM-dd")} " />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">是否结账</label>
                                        <div class="col-sm-4">
                                            <select class="form-control" id="money_onoff" name="money_onoff">
                                                <option value=""></option>
                                                @{
                                                    <!option value="0" @if (Model != null) { if (0 == Model.money_onoff) { <text> selected</text> } } else {<text> selected</text> }>未结账</!option>
                                                    <!option value="1" @if (Model != null) { if (1 == Model.money_onoff) { <text> selected</text> } }>已结账</!option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="example-input-normal" class="col-sm-4 control-label">结账方式</label>
                                        <div class="col-sm-4">
                                            <select class="form-control" id="money_way" name="money_way">
                                                <option value=""></option>
                                                @{
                                                    <!option value="1" @if (Model != null) { if (1 == Model.money_way) { <text> selected</text> } }>月结</!option>
                                                    <!option value="2" @if (Model != null) { if (2 == Model.money_way) { <text> selected</text> } }>现金</!option>
                                                    <!option value="3" @if (Model != null) { if (3== Model.money_way) { <text> selected</text> } }>小额支付</!option>

                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="col-sm-6 control-label" id="prompt" style="color:red"></div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-offset-5">
                                            <input type="button" id="submit" name="submit" class="btn btn-primary" style=" width:10%" value="提交" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- /# card -->
                    </div><!-- /# column -->
                </div><!-- /# row -->
            </div>
        </div>
    </div><!-- /# container-fluid -->

    <script language="javascript">


    </script>
</body>
</html>


